<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n - <%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <h1>‚öôÔ∏è Panel de Administraci√≥n - <%= title %></h1>
            <p id="clock">Cargando...</p>
        </div>
        <div class="header-right">
            <a href="/" class="btn btn-secondary" style="margin-right: 10px;">
                üè† Dashboard
            </a>
            <a href="/multi-dashboard" class="btn btn-secondary" style="margin-right: 10px;">
                üåê Multi-Dashboard
            </a>
            <div class="status-indicator">
                <span class="status-dot" id="status-dot"></span>
                <span id="connection-status">Desconectado</span>
            </div>
        </div>
    </header>

    <!-- Container Principal -->
    <div class="admin-container">
        
        <!-- Navegaci√≥n de pesta√±as -->
        <div class="admin-tabs">
            <button class="tab-btn active" data-tab="routers">üåê MikroTiks</button>
            <button class="tab-btn" data-tab="monitoring">üìä Multi-Dashboard Config</button>
            <button class="tab-btn" data-tab="devices">üíª Dispositivos</button>
            <button class="tab-btn" data-tab="firewall">üî• Firewall</button>
            <button class="tab-btn" data-tab="nat">üîÑ NAT</button>
            <button class="tab-btn" data-tab="bandwidth">üìä Ancho de Banda</button>
            <button class="tab-btn" data-tab="cameras">üìπ C√°maras</button>
            <button class="tab-btn" data-tab="wans">üîÄ Failover WANs</button>
            <button class="tab-btn" data-tab="dhcp">üåê DHCP</button>
            <button class="tab-btn" data-tab="routes">üó∫Ô∏è Rutas</button>
            <button class="tab-btn" data-tab="users">üë• Usuarios</button>
            <button class="tab-btn" data-tab="scheduler">‚è∞ Tareas Programadas</button>
            <button class="tab-btn" data-tab="backup">üíæ Backup & Restore</button>
        </div>
        
        <!-- Tab: Gesti√≥n de Routers MikroTik -->
        <div class="tab-content active" id="tab-routers">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üåê Gesti√≥n de Routers MikroTik</h2>
                    <button class="btn btn-success" onclick="showAddRouter()">
                        ‚ûï Agregar Router
                    </button>
                </div>
                
                <div class="section-body">
                    <p class="info-text">
                        üìå Configura m√∫ltiples routers MikroTik y cambia entre ellos f√°cilmente. 
                        El router marcado como <strong>por defecto</strong> se cargar√° autom√°ticamente al iniciar.
                    </p>
                    
                    <!-- Filtro Routers -->
                    <div class="filter-container">
                        <div class="search-box">
                            <input type="text" id="routers-search" placeholder="Buscar router por nombre, IP..." onkeyup="filterRouters()">
                        </div>
                    </div>
                    
                    <div id="routers-list" class="rules-list">
                        <div class="loading">Cargando routers...</div>
                    </div>
                </div>
            </div>

            <!-- Modal Agregar Router -->
            <div class="modal" id="modal-add-router">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚ûï Agregar Nuevo Router</h3>
                        <span class="modal-close" onclick="closeModal('modal-add-router')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-add-router">
                            <div class="form-group">
                                <label>Nombre del Router: *</label>
                                <input type="text" name="name" placeholder="Oficina Principal" required>
                            </div>
                            <div class="form-group">
                                <label>Host / IP: *</label>
                                <input type="text" name="host" placeholder="192.168.1.1" required>
                            </div>
                            <div class="form-group">
                                <label>Usuario: *</label>
                                <input type="text" name="username" value="monitor" required>
                            </div>
                            <div class="form-group">
                                <label>Contrase√±a: *</label>
                                <input type="password" name="password" required>
                            </div>
                            <div class="form-group">
                                <label>Puerto:</label>
                                <input type="number" name="port" value="8728">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Agregar</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('modal-add-router')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal Editar Router -->
            <div class="modal" id="modal-edit-router">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚úèÔ∏è Editar Router</h3>
                        <span class="modal-close" onclick="closeModal('modal-edit-router')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-edit-router">
                            <input type="hidden" name="id" id="edit-router-id">
                            <div class="form-group">
                                <label>Nombre del Router: *</label>
                                <input type="text" name="name" id="edit-router-name" placeholder="Oficina Principal" required>
                            </div>
                            <div class="form-group">
                                <label>Host / IP: *</label>
                                <input type="text" name="host" id="edit-router-host" placeholder="192.168.1.1" required>
                            </div>
                            <div class="form-group">
                                <label>Usuario: *</label>
                                <input type="text" name="username" id="edit-router-username" required>
                            </div>
                            <div class="form-group">
                                <label>Contrase√±a:</label>
                                <input type="password" name="password" id="edit-router-password" placeholder="Dejar en blanco para mantener la actual">
                                <small style="color: var(--text-secondary); font-size: 11px; margin-top: 5px; display: block;">
                                    üí° Solo ingresa una contrase√±a si deseas cambiarla
                                </small>
                            </div>
                            <div class="form-group">
                                <label>Puerto:</label>
                                <input type="number" name="port" id="edit-router-port" value="8728">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Guardar Cambios</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('modal-edit-router')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Configuraci√≥n Multi-Dashboard -->
        <div class="tab-content" id="tab-monitoring">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üìä Configuraci√≥n Multi-Dashboard</h2>
                    <button class="btn btn-success" onclick="saveMonitoringConfig()">
                        üíæ Guardar Configuraci√≥n WANs
                    </button>
                </div>
                
                <div class="section-body">
                    <p class="info-text">
                        üéõÔ∏è Configura qu√© WANs de cada router se mostrar√°n en el multi-dashboard.
                        Solo las WANs seleccionadas aparecer√°n en la vista consolidada.
                    </p>

                    <!-- Configuraci√≥n por Router -->
                    <div id="monitoring-config-container">
                        <div class="loading">Cargando configuraci√≥n...</div>
                    </div>
                </div>
            </div>

            <!-- NUEVA SECCI√ìN: Umbrales de Salud -->
            <div class="admin-section" style="margin-top: 30px;">
                <div class="section-header">
                    <h2>üíö Configuraci√≥n de Estado General (Carita Verde/Amarilla/Roja)</h2>
                    <button class="btn btn-success" onclick="saveHealthConfig()">
                        üíæ Guardar Umbrales
                    </button>
                </div>
                
                <div class="section-body">
                    <p class="info-text">
                        üòä Define cu√°ndo el sistema est√° <strong style="color: #4caf50;">BIEN (verde)</strong>, 
                        üòê con <strong style="color: #ff9800;">ADVERTENCIAS (amarillo)</strong>, 
                        o üò± en <strong style="color: #f44336;">PROBLEMAS CR√çTICOS (rojo)</strong>.
                    </p>

                    <div class="health-config-grid">
                        <!-- Umbrales de Routers -->
                        <div class="config-card">
                            <h3>üì° Routers Offline</h3>
                            <p class="config-description">Cu√°ntos routers offline son aceptables</p>
                            <div class="form-group">
                                <label>Umbral Cr√≠tico:</label>
                                <input type="number" id="health-router-offline" min="0" max="10" value="0">
                                <small>Si hay m√°s de este n√∫mero de routers ca√≠dos ‚Üí üò± CR√çTICO</small>
                            </div>
                        </div>

                        <!-- Umbrales de WANs -->
                        <div class="config-card">
                            <h3>üåê WANs Offline</h3>
                            <p class="config-description">Cu√°ntas WANs offline son tolerables</p>
                            <div class="form-group">
                                <label>Umbral Advertencia:</label>
                                <input type="number" id="health-wan-offline" min="0" max="10" value="1">
                                <small>M√°s de este n√∫mero ‚Üí üò± CR√çTICO (si 1 o menos ‚Üí üòê ADVERTENCIA)</small>
                            </div>
                        </div>

                        <!-- CPU -->
                        <div class="config-card">
                            <h3>‚ö° Uso de CPU</h3>
                            <p class="config-description">Porcentaje de CPU para alertar</p>
                            <div class="form-group">
                                <label>Advertencia (%):</label>
                                <input type="number" id="health-cpu-warning" min="0" max="100" value="70">
                                <small>CPU mayor a este % ‚Üí üòê ADVERTENCIA</small>
                            </div>
                            <div class="form-group">
                                <label>Cr√≠tico (%):</label>
                                <input type="number" id="health-cpu-critical" min="0" max="100" value="90">
                                <small>CPU mayor a este % ‚Üí üò± CR√çTICO</small>
                            </div>
                        </div>

                        <!-- Memoria -->
                        <div class="config-card">
                            <h3>üß† Uso de Memoria</h3>
                            <p class="config-description">Porcentaje de memoria para alertar</p>
                            <div class="form-group">
                                <label>Advertencia (%):</label>
                                <input type="number" id="health-memory-warning" min="0" max="100" value="75">
                                <small>Memoria mayor a este % ‚Üí üòê ADVERTENCIA</small>
                            </div>
                            <div class="form-group">
                                <label>Cr√≠tico (%):</label>
                                <input type="number" id="health-memory-critical" min="0" max="100" value="90">
                                <small>Memoria mayor a este % ‚Üí üò± CR√çTICO</small>
                            </div>
                        </div>
                    </div>

                    <!-- Vista Previa del Estado -->
                    <div class="health-preview" id="health-preview">
                        <h3>üëÅÔ∏è Vista Previa del Estado General:</h3>
                        <div class="preview-states">
                            <div class="preview-state state-good">
                                <div class="preview-emoji">üòä</div>
                                <div class="preview-info">
                                    <strong>TODO BIEN (Verde)</strong>
                                    <p>Todos los routers online, WANs activas, CPU y memoria normales</p>
                                </div>
                            </div>
                            <div class="preview-state state-warning">
                                <div class="preview-emoji">üòê</div>
                                <div class="preview-info">
                                    <strong>ADVERTENCIAS (Amarillo)</strong>
                                    <p>Algunas WANs ca√≠das o recursos en niveles de advertencia</p>
                                </div>
                            </div>
                            <div class="preview-state state-critical">
                                <div class="preview-emoji">üò±</div>
                                <div class="preview-info">
                                    <strong>CR√çTICO (Rojo)</strong>
                                    <p>Routers ca√≠dos, m√∫ltiples WANs offline, o recursos cr√≠ticos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Firewall -->
        <div class="tab-content" id="tab-firewall">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üî• Reglas de Firewall</h2>
                    <button class="btn btn-success" onclick="showAddFirewallRule()">
                        ‚ûï Nueva Regla
                    </button>
                </div>
                
                <div class="section-body">
                    <!-- Filtros Firewall -->
                    <div class="filter-container">
                        <div class="search-box">
                            <input type="text" id="firewall-search" placeholder="Buscar por IP, puerto, protocolo, comentario..." onkeyup="filterFirewallRules()">
                        </div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all" onclick="filterFirewallByAction('all')">Todas</button>
                            <button class="filter-btn" data-filter="accept" onclick="filterFirewallByAction('accept')">ACCEPT</button>
                            <button class="filter-btn" data-filter="drop" onclick="filterFirewallByAction('drop')">DROP</button>
                            <button class="filter-btn" data-filter="reject" onclick="filterFirewallByAction('reject')">REJECT</button>
                        </div>
                    </div>
                    
                    <div id="firewall-rules-list" class="rules-list">
                        <div class="loading">Cargando reglas...</div>
                    </div>
                </div>
            </div>

            <!-- Formulario para agregar regla -->
            <div class="modal" id="modal-firewall">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Nueva Regla de Firewall</h3>
                        <span class="modal-close" onclick="closeModal('modal-firewall')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-firewall">
                            <div class="form-group">
                                <label>Chain:</label>
                                <select name="chain" required>
                                    <option value="input">INPUT (tr√°fico hacia el router)</option>
                                    <option value="forward">FORWARD (tr√°fico que pasa por el router)</option>
                                    <option value="output">OUTPUT (tr√°fico desde el router)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Acci√≥n:</label>
                                <select name="action" required>
                                    <option value="accept">ACCEPT (permitir)</option>
                                    <option value="drop">DROP (descartar silenciosamente)</option>
                                    <option value="reject">REJECT (rechazar con respuesta)</option>
                                    <option value="log">LOG (registrar)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Protocolo:</label>
                                <select name="protocol">
                                    <option value="">Todos</option>
                                    <option value="tcp">TCP</option>
                                    <option value="udp">UDP</option>
                                    <option value="icmp">ICMP</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>IP Origen:</label>
                                <input type="text" name="src-address" placeholder="192.168.1.0/24 o vac√≠o para todas">
                            </div>
                            <div class="form-group">
                                <label>IP Destino:</label>
                                <input type="text" name="dst-address" placeholder="0.0.0.0/0 o vac√≠o para todas">
                            </div>
                            <div class="form-group">
                                <label>Puerto Destino:</label>
                                <input type="text" name="dst-port" placeholder="80,443 o rango 8000-9000">
                            </div>
                            <div class="form-group">
                                <label>Comentario:</label>
                                <input type="text" name="comment" placeholder="Descripci√≥n de la regla">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Agregar Regla</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('modal-firewall')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: NAT -->
        <div class="tab-content" id="tab-nat">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üîÑ Reglas NAT (Port Forwarding)</h2>
                    <button class="btn btn-success" onclick="showAddNATRule()">
                        ‚ûï Nueva Regla NAT
                    </button>
                </div>
                
                <div class="section-body">
                    <!-- Filtros -->
                    <div class="filter-container">
                        <div class="search-box">
                            <input type="text" id="nat-search" placeholder="Buscar por IP, puerto, comentario..." onkeyup="filterNATRules()">
                        </div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all" onclick="filterNATByType('all')">Todas</button>
                            <button class="filter-btn" data-filter="dstnat" onclick="filterNATByType('dstnat')">DSTNAT</button>
                            <button class="filter-btn" data-filter="srcnat" onclick="filterNATByType('srcnat')">SRCNAT</button>
                            <button class="filter-btn" data-filter="disabled" onclick="filterNATByType('disabled')">Deshabilitadas</button>
                        </div>
                    </div>
                    
                    <div id="nat-rules-list" class="rules-list">
                        <div class="loading">Cargando reglas NAT...</div>
                    </div>
                </div>
            </div>

            <!-- Formulario NAT -->
            <div class="modal" id="modal-nat">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Nueva Regla NAT</h3>
                        <span class="modal-close" onclick="closeModal('modal-nat')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-nat">
                            <div class="form-group">
                                <label>Tipo:</label>
                                <select name="chain" required>
                                    <option value="dstnat">DSTNAT (Port Forwarding)</option>
                                    <option value="srcnat">SRCNAT (Masquerade)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Acci√≥n:</label>
                                <select name="action" required>
                                    <option value="dst-nat">DST-NAT (redirigir a IP interna)</option>
                                    <option value="masquerade">MASQUERADE (ocultar IP)</option>
                                    <option value="src-nat">SRC-NAT</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Protocolo:</label>
                                <select name="protocol" required>
                                    <option value="tcp">TCP</option>
                                    <option value="udp">UDP</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Puerto Externo:</label>
                                <input type="number" name="dst-port" placeholder="8080" required>
                            </div>
                            <div class="form-group">
                                <label>IP Interna:</label>
                                <input type="text" name="to-addresses" placeholder="192.168.1.100" required>
                            </div>
                            <div class="form-group">
                                <label>Puerto Interno:</label>
                                <input type="number" name="to-ports" placeholder="80" required>
                            </div>
                            <div class="form-group">
                                <label>Interfaz de entrada:</label>
                                <select name="in-interface" id="nat-interfaces">
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Comentario:</label>
                                <input type="text" name="comment" placeholder="Servidor web">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Agregar Regla</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('modal-nat')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Ancho de Banda (Queue) -->
        <div class="tab-content" id="tab-bandwidth">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üìä Control de Ancho de Banda</h2>
                    <button class="btn btn-success" onclick="showAddQueue()">
                        ‚ûï Nueva Cola (Queue)
                    </button>
                </div>
                
                <div class="section-body">
                    <div id="queue-list" class="rules-list">
                        <div class="loading">Cargando colas...</div>
                    </div>
                </div>
            </div>

            <!-- Formulario Queue -->
            <div class="modal" id="modal-queue">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Nueva Cola de Tr√°fico</h3>
                        <span class="modal-close" onclick="closeModal('modal-queue')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-queue">
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" name="name" placeholder="Cliente-192.168.1.100" required>
                            </div>
                            <div class="form-group">
                                <label>IP/Red de Destino:</label>
                                <input type="text" name="target" placeholder="192.168.1.100/32" required>
                            </div>
                            <div class="form-group">
                                <label>L√≠mite de Descarga (Download):</label>
                                <input type="text" name="max-limit-download" placeholder="10M (10 Mbps)">
                                <small>Ejemplos: 1M, 10M, 100M</small>
                            </div>
                            <div class="form-group">
                                <label>L√≠mite de Subida (Upload):</label>
                                <input type="text" name="max-limit-upload" placeholder="5M (5 Mbps)">
                            </div>
                            <div class="form-group">
                                <label>Prioridad (1-8):</label>
                                <input type="number" name="priority" value="8" min="1" max="8">
                                <small>1 = Mayor prioridad, 8 = Menor prioridad</small>
                            </div>
                            <div class="form-group">
                                <label>Comentario:</label>
                                <input type="text" name="comment" placeholder="Oficina principal">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Agregar Cola</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('modal-queue')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: C√°maras -->
        <div class="tab-content" id="tab-cameras">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üìπ C√°maras IP Detectadas</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" onclick="showAddManualCamera()">
                            ‚ûï Agregar Manual
                        </button>
                        <button class="btn btn-primary" onclick="loadCameras()">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>
                
                <div class="section-body">
                    <div class="cameras-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="cameras-total">0</div>
                            <div class="stat-label">Total C√°maras</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="cameras-online">0</div>
                            <div class="stat-label">En L√≠nea</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="cameras-offline">0</div>
                            <div class="stat-label">Desconectadas</div>
                        </div>
                    </div>
                    
                    <!-- Filtro C√°maras -->
                    <div class="filter-container">
                        <div class="search-box">
                            <input type="text" id="cameras-search" placeholder="Buscar por IP, marca, ubicaci√≥n..." onkeyup="filterCameras()">
                        </div>
                    </div>
                    
                    <div id="cameras-list" class="cameras-grid">
                        <div class="loading">Cargando c√°maras...</div>
                    </div>
                </div>
            </div>

            <!-- Modal Agregar C√°mara Manual -->
            <div class="modal" id="modal-camera-manual">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>‚ûï Agregar C√°mara Manualmente</h3>
                        <span class="modal-close" onclick="closeModal('modal-camera-manual')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-camera-manual">
                            <div class="form-group">
                                <label>IP de la C√°mara: *</label>
                                <input type="text" name="ip" placeholder="192.168.1.100" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre / Ubicaci√≥n:</label>
                                <input type="text" name="hostname" placeholder="C√°mara Entrada Principal">
                            </div>
                            <div class="form-group">
                                <label>Marca:</label>
                                <select name="brand">
                                    <option value="Desconocida">Desconocida</option>
                                    <option value="Hikvision">Hikvision</option>
                                    <option value="Dahua">Dahua</option>
                                    <option value="Axis">Axis</option>
                                    <option value="TP-Link">TP-Link / Tapo</option>
                                    <option value="Uniview">Uniview</option>
                                    <option value="Reolink">Reolink</option>
                                    <option value="Xiaomi">Xiaomi / Yi</option>
                                    <option value="Ubiquiti">Ubiquiti UniFi</option>
                                    <option value="Samsung">Samsung Wisenet</option>
                                    <option value="Google Nest">Google Nest</option>
                                    <option value="Ring">Ring</option>
                                    <option value="Arlo">Arlo</option>
                                    <option value="Otra">Otra Marca</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>MAC Address (opcional):</label>
                                <input type="text" name="mac" placeholder="AA:BB:CC:DD:EE:FF">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Agregar C√°mara</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('modal-camera-manual')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Failover WANs -->
        <div class="tab-content" id="tab-wans">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üîÄ Configuraci√≥n de Failover y Balanceo de WANs</h2>
                    <button class="btn btn-primary" onclick="loadWANsConfig()">
                        üîÑ Actualizar
                    </button>
                </div>
                
                <div class="section-body">
                    <!-- Estado actual de WANs -->
                    <div class="wans-status-section">
                        <h3>üìä Estado Actual de WANs</h3>
                        <div id="wans-status-list" class="wans-status-grid">
                            <div class="loading">Cargando WANs...</div>
                        </div>
                    </div>

                    <!-- Instrucciones de configuraci√≥n -->
                    <div class="wans-info-section">
                        <h3>‚öôÔ∏è Configuraci√≥n de Failover</h3>
                        <div class="info-card">
                            <h4>üéØ Opciones de Configuraci√≥n:</h4>
                            <ul>
                                <li><strong>PCC (Per Connection Classifier):</strong> Balanceo de carga avanzado</li>
                                <li><strong>Distance & Check Gateway:</strong> Failover autom√°tico basado en distancia de rutas</li>
                                <li><strong>Recursive Routing:</strong> Monitoreo activo con Netwatch</li>
                            </ul>
                            
                            <h4>üìù Configuraci√≥n Manual Recomendada:</h4>
                            <pre class="code-block">
# 1. Configurar distancias en rutas (Gateway Check)
/ip route
add dst-address=0.0.0.0/0 gateway=<WAN1_IP> distance=1 check-gateway=ping
add dst-address=0.0.0.0/0 gateway=<WAN2_IP> distance=2 check-gateway=ping

# 2. Configurar Netwatch para monitoreo
/tool netwatch
add host=8.8.8.8 interval=10s down-script="/ip route set [find gateway=<WAN1_IP>] disabled=yes"
add host=8.8.8.8 interval=10s up-script="/ip route set [find gateway=<WAN1_IP>] disabled=no"

# 3. Marcar rutas para balanceo PCC
/ip route
add dst-address=0.0.0.0/0 gateway=<WAN1_IP> routing-mark=to-wan1
add dst-address=0.0.0.0/0 gateway=<WAN2_IP> routing-mark=to-wan2
                            </pre>
                            
                            <!-- Panel de administraci√≥n para seleccionar WANs y marcar backup -->
                            <div class="admin-wans-config">
                                <h4>üîß Seleccionar interfaces WAN (desde el panel)</h4>
                                <p>Marca las interfaces que actuar√°n como WAN y selecciona cu√°l ser√° la backup.</p>
                                <div id="wans-admin-list">Cargando interfaces...</div>
                                <div style="margin-top:10px;">
                                    <button class="btn btn-success" id="btn-save-wans">Guardar configuraci√≥n WAN</button>
                                </div>
                            </div>
                            <p style="margin-top: 15px;">
                                üí° <strong>Tip:</strong> Para configuraci√≥n avanzada, accede a WinBox o WebFig del MikroTik.
                                Esta interfaz permite monitorear y hacer cambios b√°sicos de rutas.
                            </p>
                        </div>
                    </div>

                    <!-- Rutas activas -->
                    <div class="wans-routes-section">
                        <h3>üó∫Ô∏è Rutas por Defecto Configuradas</h3>
                        <div id="wan-routes-list" class="routes-list">
                            <div class="loading">Cargando rutas...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: DHCP -->
        <div class="tab-content" id="tab-dhcp">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üåê Servidor DHCP</h2>
                    <button class="btn btn-success" onclick="showAddDHCPLease()">
                        ‚ûï Nueva Reserva DHCP
                    </button>
                </div>
                
                <div class="section-body">
                    <!-- Filtro DHCP -->
                    <div class="filter-container">
                        <div class="search-box">
                            <input type="text" id="dhcp-search" placeholder="Buscar por IP, MAC, hostname..." onkeyup="filterDHCP()">
                        </div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all" onclick="filterDHCPByType('all')">Todas</button>
                            <button class="filter-btn" data-filter="static" onclick="filterDHCPByType('static')">Est√°ticas</button>
                            <button class="filter-btn" data-filter="dynamic" onclick="filterDHCPByType('dynamic')">Din√°micas</button>
                        </div>
                    </div>
                    
                    <div id="dhcp-leases-list" class="rules-list">
                        <div class="loading">Cargando reservas DHCP...</div>
                    </div>
                </div>
            </div>

            <!-- Formulario DHCP -->
            <div class="modal" id="modal-dhcp">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Nueva Reserva DHCP</h3>
                        <span class="modal-close" onclick="closeModal('modal-dhcp')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-dhcp">
                            <div class="form-group">
                                <label>Direcci√≥n MAC:</label>
                                <input type="text" name="mac-address" placeholder="00:11:22:33:44:55" required>
                            </div>
                            <div class="form-group">
                                <label>Direcci√≥n IP:</label>
                                <input type="text" name="address" placeholder="192.168.1.50" required>
                            </div>
                            <div class="form-group">
                                <label>Comentario/Nombre:</label>
                                <input type="text" name="comment" placeholder="Servidor de archivos">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" name="always-broadcast" value="yes">
                                    Siempre enviar broadcast
                                </label>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Agregar Reserva</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('modal-dhcp')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Rutas -->
        <div class="tab-content" id="tab-routes">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üó∫Ô∏è Tabla de Rutas</h2>
                    <button class="btn btn-success" onclick="showAddRoute()">
                        ‚ûï Nueva Ruta
                    </button>
                </div>
                
                <div class="section-body">
                    <div id="routes-list" class="rules-list">
                        <div class="loading">Cargando rutas...</div>
                    </div>
                </div>
            </div>

            <!-- Formulario Rutas -->
            <div class="modal" id="modal-route">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Nueva Ruta Est√°tica</h3>
                        <span class="modal-close" onclick="closeModal('modal-route')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-route">
                            <div class="form-group">
                                <label>Red de Destino:</label>
                                <input type="text" name="dst-address" placeholder="10.0.0.0/24" required>
                            </div>
                            <div class="form-group">
                                <label>Gateway:</label>
                                <input type="text" name="gateway" placeholder="192.168.1.1" required>
                            </div>
                            <div class="form-group">
                                <label>Distancia (M√©trica):</label>
                                <input type="number" name="distance" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label>Comentario:</label>
                                <input type="text" name="comment" placeholder="Ruta a oficina remota">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Agregar Ruta</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('modal-route')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Dispositivos Conectados (NUEVO) -->
        <div class="tab-content" id="tab-devices">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üíª Dispositivos Conectados</h2>
                    <button class="btn btn-primary" onclick="refreshDevices()">
                        üîÑ Actualizar Lista
                    </button>
                </div>
                
                <div class="section-body">
                    <p class="info-text">
                        üì± Vista unificada de todos los dispositivos conectados con acciones r√°pidas.
                        Desde aqu√≠ puedes crear reglas de firewall, NAT, limitar ancho de banda o bloquear dispositivos.
                    </p>

                    <!-- Filtros Avanzados -->
                    <div class="filter-container">
                        <div class="search-box">
                            <input type="text" id="devices-search" placeholder="Buscar por IP, MAC, hostname..." onkeyup="filterDevices()">
                        </div>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all" onclick="filterDevicesByStatus('all')">Todos</button>
                            <button class="filter-btn" data-filter="active" onclick="filterDevicesByStatus('active')">Activos</button>
                            <button class="filter-btn" data-filter="inactive" onclick="filterDevicesByStatus('inactive')">Inactivos</button>
                            <button class="filter-btn" data-filter="cameras" onclick="filterDevicesByType('cameras')">üìπ C√°maras</button>
                        </div>
                    </div>
                    
                    <!-- Lista de Dispositivos Mejorada -->
                    <div id="devices-list-enhanced" class="devices-enhanced-grid">
                        <div class="loading">Cargando dispositivos...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Usuarios -->
        <div class="tab-content" id="tab-users">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üë• Usuarios del Sistema</h2>
                    <button class="btn btn-success" onclick="showAddUser()">
                        ‚ûï Nuevo Usuario
                    </button>
                </div>
                
                <div class="section-body">
                    <div id="users-list" class="rules-list">
                        <div class="loading">Cargando usuarios...</div>
                    </div>
                </div>
            </div>

            <!-- Formulario Usuarios -->
            <div class="modal" id="modal-user">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Nuevo Usuario</h3>
                        <span class="modal-close" onclick="closeModal('modal-user')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-user">
                            <div class="form-group">
                                <label>Nombre de Usuario:</label>
                                <input type="text" name="name" placeholder="admin2" required>
                            </div>
                            <div class="form-group">
                                <label>Contrase√±a:</label>
                                <input type="password" name="password" placeholder="********" required>
                            </div>
                            <div class="form-group">
                                <label>Grupo:</label>
                                <select name="group" required>
                                    <option value="full">Full (acceso completo)</option>
                                    <option value="read">Read (solo lectura)</option>
                                    <option value="write">Write (lectura y escritura)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Comentario:</label>
                                <input type="text" name="comment" placeholder="Usuario de soporte">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Crear Usuario</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('modal-user')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Tareas Programadas -->
        <div class="tab-content" id="tab-scheduler">
            <div class="admin-section">
                <div class="section-header">
                    <h2>‚è∞ Tareas Programadas (Scheduler)</h2>
                    <button class="btn btn-success" onclick="showAddScheduler()">
                        ‚ûï Nueva Tarea
                    </button>
                </div>
                
                <div class="section-body">
                    <div id="scheduler-list" class="rules-list">
                        <div class="loading">Cargando tareas programadas...</div>
                    </div>
                </div>
            </div>

            <!-- Formulario Scheduler -->
            <div class="modal" id="modal-scheduler">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Nueva Tarea Programada</h3>
                        <span class="modal-close" onclick="closeModal('modal-scheduler')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="form-scheduler">
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" name="name" placeholder="backup-diario" required>
                            </div>
                            <div class="form-group">
                                <label>Intervalo:</label>
                                <input type="text" name="interval" placeholder="1d (diario), 1h (cada hora)">
                                <small>Ejemplos: 1d, 12h, 30m, 1w</small>
                            </div>
                            <div class="form-group">
                                <label>Hora de inicio:</label>
                                <input type="time" name="start-time">
                            </div>
                            <div class="form-group">
                                <label>Script/Comando:</label>
                                <textarea name="on-event" rows="5" placeholder="/system backup save name=backup" required></textarea>
                                <small>Comandos de RouterOS</small>
                            </div>
                            <div class="form-group">
                                <label>Comentario:</label>
                                <input type="text" name="comment" placeholder="Backup autom√°tico diario">
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Crear Tarea</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('modal-scheduler')">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Backup & Restore -->
        <div class="tab-content" id="tab-backup">
            <div class="admin-section">
                <div class="section-header">
                    <h2>üíæ Backup y Restauraci√≥n</h2>
                </div>
                
                <div class="section-body">
                    <div class="backup-actions">
                        <div class="backup-card">
                            <h3>üíæ Crear Backup</h3>
                            <p>Genera un respaldo completo de la configuraci√≥n del router</p>
                            <button class="btn btn-success" onclick="createBackup()">
                                Crear Backup Ahora
                            </button>
                        </div>

                        <div class="backup-card">
                            <h3>üì• Exportar Configuraci√≥n</h3>
                            <p>Exporta la configuraci√≥n en formato texto (.rsc)</p>
                            <button class="btn btn-primary" onclick="exportConfig()">
                                Exportar Configuraci√≥n
                            </button>
                        </div>

                        <div class="backup-card">
                            <h3>üîÑ Reiniciar Router</h3>
                            <p>Reinicia el router MikroTik</p>
                            <button class="btn btn-warning" onclick="rebootRouter()">
                                Reiniciar Sistema
                            </button>
                        </div>

                        <div class="backup-card">
                            <h3>‚ö†Ô∏è Reset de F√°brica</h3>
                            <p>Restaura el router a configuraci√≥n de f√°brica (¬°CUIDADO!)</p>
                            <button class="btn btn-danger" onclick="factoryReset()">
                                Reset de F√°brica
                            </button>
                        </div>
                    </div>

                    <div class="backups-list">
                        <h3>üìã Backups Disponibles</h3>
                        <div id="backups-available" class="rules-list">
                            <div class="loading">Cargando backups...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Panel de Alertas Flotante -->
    <div id="alerts-panel" class="alerts-panel hidden">
        <div class="alerts-header">
            <h4>üö® Alertas de Routers</h4>
            <button class="alerts-close" onclick="toggleAlertsPanel()">√ó</button>
        </div>
        <div class="alerts-body" id="alerts-list">
            <div class="no-alerts">Sin alertas recientes</div>
        </div>
    </div>

    <!-- Bot√≥n flotante de alertas -->
    <button id="alerts-toggle" class="alerts-toggle" onclick="toggleAlertsPanel()">
        <span class="alerts-badge" id="alerts-count">0</span>
        üîî
    </button>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/admin.js"></script>
</body>
</html>
